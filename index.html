<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vera C. Rubin Image Viewer with Plate Solving</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>

    html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;background:black;color:white;font-family:sans-serif;}
    #viewer{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;background:black;z-index:0;}

    #header {
      position: fixed;
      bottom: 10px; /* Increased from 1px for better visibility */
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 800px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 1em 1.5em;
      border-radius: 8px;
      z-index: 1001;
      text-align: center;
      font-weight: 600;
      /* Removed duplicate position:relative */
      box-sizing: border-box; /* Ensures padding is included in width */
    }

    #header p {
      font-size: 0.75em;
      margin-top: 0.25em;
    }

    #close-header {
      position: absolute;
      top: 0.3em;
      right: 0.5em;
      background: none;
      border: none;
      color: white;
      font-size: 1.2em;
      cursor: pointer;
    }

    #controls{position:fixed;top:3.5em;left:50%;transform:translateX(-50%);display:flex;gap:0.5em;align-items:center;background:rgba(0,0,0,0.6);padding:0.5em 1em;border-radius:8px;z-index:1000;flex-wrap:wrap;max-width:95vw;justify-content:center;}
    #api-key{width:280px;max-width:60vw;padding:0.3em 0.6em;font-size:0.9em;}
    #selector,#platesolve-btn,#save-api-key{padding:0.3em 0.6em;font-size:0.9em;width:auto;}
    #status { position: fixed; bottom: 5.5em; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 0.5em 1em; border-radius: 8px; font-size: 0.85em; z-index: 1000; max-width: 90vw; text-align: center; pointer-events: none; }

  </style>
</head>
<body>
  <div id="header">
    <button id="close-header" aria-label="Close header" title="Close" style="position:absolute; top:0.3em; right:0.5em; background:none; border:none; color:white; font-size:1.2em; cursor:pointer;">‚úï</button>
    <h2><i class="fas fa-star"></i> <a href="https://rubinobservatory.org/">Vera C. Rubin Image Viewer</a></h2>
    <p>üîç Zoom in any part of the image! üõ∞Ô∏è To find astronomical coordinates, enable Plate Solving, then click on the image to analyze it with <a href="https://nova.astrometry.net/api_help" target="_blank">Astrometry.net API</a></p>
    <p>If you like this, consider a <a target="_blank" href="https://www.healpalestine.org/donate/">donation</a></p>
  </div>    

  <div id="controls">
    <select id="selector" aria-label="Select image to view">
      <option>Loading images...</option>
    </select>
    <button id="platesolve-btn" disabled><i class="fas fa-crosshairs"></i> Enable Plate Solving</button>
    <input type="text" id="api-key" placeholder="Enter your Astrometry.net API key">
    <button id="save-api-key"><i class="fas fa-save"></i> Save API Key</button>
    <span id="status">Waiting for a scene to analyze...</span>
  </div>

  <div id="viewer"></div>
  <div id="results"></div>

  <script>
    const selector = document.getElementById('selector');
    const plateSolveBtn = document.getElementById('platesolve-btn');
    const status = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const apiKeyInput = document.getElementById('api-key');
    const saveApiKeyBtn = document.getElementById('save-api-key');
    let viewer, plateSolvingEnabled = false, currentImageSource;

    document.getElementById('close-header').addEventListener('click', () => {
     document.getElementById('header').style.display = 'none';
    });

    fetch('images.json')
      .then(response => {
        if (!response.ok) throw new Error('Failed to load images.json');
        return response.json();
      })
      .then(images => {
        selector.innerHTML = '';
        if (!images.length) {
          selector.innerHTML = '<option>No images found</option>';
          return;
        }

        images.forEach(image => {
          const option = document.createElement('option');
          option.value = image;
          option.text = image.split('/').pop().replace('.dzi', '').replace(/_/g, ' ');
          selector.appendChild(option);
        });

        currentImageSource = images[0];
        viewer = OpenSeadragon({
          id: "viewer",
          prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
          tileSources: currentImageSource,
          crossOriginPolicy: 'Anonymous',
          showNavigator: true,
          animationTime: 0.5,
          blendTime: 0.1,
          constrainDuringPan: true,
          maxZoomPixelRatio: 2,
          minZoomLevel: 1,
          visibilityRatio: 1,
          zoomPerClick: 2,
        });

        setupPlateSolving();
        plateSolveBtn.disabled = false;
      })
      .catch(error => {
        selector.innerHTML = `<option>Error loading images</option>`;
        console.error(error);
      });

    selector.addEventListener('change', () => {
      if (viewer) {
        currentImageSource = selector.value;
        viewer.open(selector.value);
      }
    });

    function setupPlateSolving() {
      viewer.addHandler('canvas-click', async function(event) {
        if (!plateSolvingEnabled) return;
        event.preventDefaultAction = true;
        status.textContent = 'Extracting tile from image...';

        const img = await viewer.drawer.canvas.toDataURL('image/jpeg');
        const imageBlob = await fetch(img).then(res => res.blob());
        status.textContent = 'Sending to Astrometry.net...';

        try {
          const result = await sendToAstrometry(imageBlob);
          status.textContent = 'Plate solving complete!';
          resultsDiv.innerHTML = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
          resultsDiv.style.display = 'block';
        } catch (err) {
          status.textContent = `Error: ${err.message}`;
        }
      });
    }

    async function sendToAstrometry(imageBlob) {
      const API_KEY = apiKeyInput.value.trim();
      if (!API_KEY) throw new Error('API key is required.');

      const loginRes = await fetch('https://nova.astrometry.net/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `request-json=${encodeURIComponent(JSON.stringify({ apikey: API_KEY }))}`
      });
      const login = await loginRes.json();
      if (login.status !== 'success') throw new Error('Astrometry login failed');
      const session = login.session;

      const formData = new FormData();
      formData.append('request-json', JSON.stringify({
        session: session,
        publicly_visible: 'y',
        allow_modifications: 'y',
        allow_commercial_use: 'd'
      }));
      formData.append('session', session);
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); // e.g., 2025-06-27T15-45-30-123Z
      const filename = `vera_rubin_tile_${timestamp}.jpg`;
      formData.append('file', imageBlob, filename);

      const uploadRes = await fetch('https://nova.astrometry.net/api/upload', {
        method: 'POST',
        body: formData
      });
      const upload = await uploadRes.json();
      if (upload.status !== 'success') throw new Error('Upload failed');
      const subId = upload.subid;

      return await pollForJobCompletion(subId);
    }

    async function pollForJobCompletion(subId) {
      for (let i = 0; i < 30; i++) {
        await new Promise(r => setTimeout(r, 10000));
        const res = await fetch(`https://nova.astrometry.net/api/submissions/${subId}`);
        const data = await res.json();
        if (data.jobs.length) {
          const user_image = data.user_images[0];
          const jobId = data.jobs[0];
          const jobRes = await fetch(`https://nova.astrometry.net/api/jobs/${jobId}`);
          const job = await jobRes.json();
    if (job.status === 'success') return {
          "status": "success",
          "url": `https://nova.astrometry.net/user_images/${user_image}`,
    }
          if (job.status === 'failure') throw new Error('Plate solving failed');
        }
      }
      throw new Error('Plate solving timed out');
    }

    plateSolveBtn.addEventListener('click', () => {
      plateSolvingEnabled = !plateSolvingEnabled;
      plateSolveBtn.innerHTML = plateSolvingEnabled
        ? '<i class="fas fa-ban"></i> Disable Plate Solving'
        : '<i class="fas fa-crosshairs"></i> Enable Plate Solving';
      status.textContent = plateSolvingEnabled
        ? 'Click on the image to extract a tile and solve its coordinates'
        : 'Click "Enable Plate Solving" then click on the image to solve coordinates';
    });

    saveApiKeyBtn.addEventListener('click', () => {
      const apiKey = apiKeyInput.value.trim();
      if (apiKey) status.textContent = 'API key saved.';
    });
  </script>
</body>
</html>

